<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPHS Directory</title>
    <link rel="icon" href="mascot.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* --- THEME: KINETIC GOLD --- */
        :root {
            --primary: #FFD700;
            --bg-body: #090909;
            --bg-card: #111111;
            --text-main: #ffffff;
            --text-muted: #888;
            --border: 1px solid rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- NAV (Gold Restored) --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            height: 80px; padding: 0 5%;
            background: rgba(9, 9, 9, 0.95); border-bottom: 1px solid rgba(255,255,255,0.05);
            position: fixed; top: 0; width: 100%; z-index: 1000;
            backdrop-filter: blur(10px); transition: transform 0.3s ease;
        }
        nav.nav-hidden { transform: translateY(-100%); }

        .logo { 
            font-family: 'Teko', sans-serif; 
            font-size: 2.2rem; 
            font-weight: 600; 
            color: white; 
            text-transform: uppercase; 
            cursor: pointer; 
            line-height: 1; 
            letter-spacing: 1px; 
        }
        .logo span { color: var(--primary); } /* GOLD IS BACK */

        /* --- HERO --- */
        .hero {
            position: relative; padding: 10rem 1rem 5rem 1rem; text-align: center;
            background: radial-gradient(circle at 50% 40%, rgba(255, 215, 0, 0.15) 0%, rgba(9, 9, 9, 1) 60%), repeating-linear-gradient(45deg, #111, #111 10px, #151515 10px, #151515 20px);
            border-bottom: 1px solid var(--primary);
        }
        
        /* FIXED MASCOT BOX (No White Background) */
        .mascot-box {
            width: 140px; height: 140px; margin: 0 auto 2rem auto;
            border-radius: 50%; border: 3px solid var(--primary); 
            /* Changed from #fff to transparent glass */
            background: #fff; 
            backdrop-filter: blur(5px);
            overflow: hidden; box-shadow: 0 0 60px rgba(255, 215, 0, 0.6);
            animation: jumpIn 1s cubic-bezier(0.175, 0.885, 0.32, 1.275), float 4s ease-in-out 1s infinite;
            display: flex; align-items: center; justify-content: center;
        }
        .mascot-img { width: 90%; height: 90%; object-fit: contain; }

        .hero h1 {
            font-family: 'Teko', sans-serif; font-size: 5rem; line-height: 0.85; 
            text-transform: uppercase; margin-bottom: 1rem; color: white;
            text-shadow: 4px 4px 0px #222; letter-spacing: 2px;
        }
        .hero h1 span { color: var(--primary); }
        .hero p { color: #aaa; font-size: 1.2rem; max-width: 600px; margin: 0 auto; letter-spacing: 1px; font-weight: 300; }

        /* --- GRID --- */
        .container { max-width: 1300px; margin: 0 auto; padding: 4rem 1rem; }
        .section-header { 
            border-left: 6px solid var(--primary); padding-left: 20px; margin-bottom: 2rem; 
            font-family: 'Teko'; font-size: 2.5rem; text-transform: uppercase; letter-spacing: 1px; line-height: 1;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; perspective: 1000px; }

        /* --- CARDS --- */
        .card {
            background: var(--bg-card); border: var(--border); border-radius: 0 0 8px 8px;
            display: flex; flex-direction: column; position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer; border-top: 4px solid var(--primary);
        }
        .card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 50px rgba(0,0,0,0.8); border-color: #333; border-top-color: #fff; }
        .card-img-box { height: 180px; background: #151515; overflow: hidden; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card:hover .card-img { transform: scale(1.1); filter: contrast(1.1); }
        .card-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #222; background: #151515; }
        .card-body { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }
        .card-cat { color: var(--primary); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .card h3 { font-family: 'Teko', sans-serif; font-size: 2rem; font-weight: 500; color: white; margin-bottom: 0.5rem; line-height: 1; }
        .card p { color: #888; font-size: 0.95rem; line-height: 1.5; margin-bottom: 1.5rem; font-weight: 400; }
        .card-foot { margin-top: auto; padding-top: 1rem; border-top: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .price { font-weight: 800; color: var(--bg-body); background: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; }
        .view-btn { font-size: 0.8rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 1px; }

        /* --- DASHBOARD TABLES --- */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #111; }
        .admin-table th { text-align: left; padding: 15px; color: #666; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid #333; }
        .admin-table td { padding: 15px; border-bottom: 1px solid #222; color: #ddd; }
        .badge { padding: 4px 8px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; border-radius: 2px; }
        .b-live { background: rgba(0,255,0,0.1); color: #0f0; border: 1px solid #0f0; }
        .b-wait { background: rgba(255,215,0,0.1); color: gold; border: 1px solid gold; }
        .b-dead { background: rgba(255,0,0,0.1); color: #f44; border: 1px solid #f44; }

        /* --- BUTTONS --- */
        .btn { padding: 0.7rem 1.5rem; border-radius: 2px; border: none; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: 0.2s; font-size: 0.9rem; font-family:'Inter'; letter-spacing:0.5px; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-primary:hover { background: white; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid #444; color: white; }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: rgba(255,0,0,0.2); color: #ff5555; border: 1px solid #ff5555; }

        /* --- STICKY AD --- */
        #sticky-ad {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #111; border-top: 2px solid var(--primary);
            padding: 15px; display: flex; justify-content: center; align-items: center; gap: 20px;
            z-index: 990; transform: translateY(100%); transition: 0.5s;
        }
        #sticky-ad.visible { transform: translateY(0); }
        .ad-text { color: white; font-weight: 700; text-transform: uppercase; font-family: 'Teko'; font-size: 1.4rem; letter-spacing: 1px; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; animation: fadeUp 0.3s; }
        .modal-box { background: #111; width: 95%; max-width: 500px; border: 1px solid #333; border-radius: 8px; overflow: hidden; box-shadow: 0 20px 60px black; border-top: 4px solid var(--primary); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-family: 'Teko'; font-size: 1.8rem; text-transform: uppercase; }
        .modal-body { padding: 2rem; max-height: 80vh; overflow-y: auto; overscroll-behavior: contain; }
        
        input, textarea, select { width: 100%; padding: 12px; background: #080808; border: 1px solid #333; color: white; margin-bottom: 15px; border-radius: 4px; font-family: 'Inter'; }
        input:focus { border-color: var(--primary); outline: none; }
        label { display: block; font-size: 0.7rem; color: #666; margin-bottom: 5px; text-transform: uppercase; font-weight: 700; }

        /* Toast */
        #toast-box { position: fixed; bottom: 80px; right: 20px; z-index: 3000; }
        .toast { background: #151515; border-left: 4px solid var(--primary); padding: 15px 20px; color: white; margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 280px; animation: slideIn 0.3s; font-weight: 600; }

        /* Helpers */
        .view-section { display: none; }
        .view-section.active { display: block; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes jumpIn { 0% { transform: scale(0) translateY(50px); opacity: 0; } 60% { transform: scale(1.1) translateY(-20px); opacity: 1; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; padding: 10px 15px; cursor: pointer; font-size: 1.5rem; z-index: 10; transition: 0.2s; }
        .slider-btn:hover { background: var(--primary); color: black; }
        .prev-btn { left: 0; } .next-btn { right: 0; }

        /* --- STRATEGIC BANNER --- */
        .cta-banner {
            background: linear-gradient(90deg, #111 0%, #161616 100%);
            border-top: 1px solid #222; border-bottom: 1px solid #222;
            padding: 3rem 5%; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 3rem;
            text-align: left; position: relative; overflow: hidden; margin-top: -1px;
        }
        .cta-banner::before { content:''; position:absolute; left:0; top:0; height:100%; width:4px; background:var(--primary); }
        .cta-text h2 { font-family: 'Teko'; font-size: 3rem; color: white; line-height: 0.9; margin-bottom: 10px; text-transform: uppercase; }
        .cta-text h2 span { color: var(--primary); }
        .cta-text p { color: #999; font-size: 1.1rem; max-width: 500px; }
        .cta-btn { padding: 1rem 3rem; font-size: 1.2rem; font-weight: 800; background: white; color: black; border: none; cursor: pointer; transition: 0.3s; font-family: 'Teko'; letter-spacing: 1px; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); }
        .cta-btn:hover { background: var(--primary); transform: scale(1.05); }

        /* Featured Banner */
        .featured-box { 
            background: linear-gradient(45deg, #1a1a1a, #000); 
            border: 2px solid var(--primary); 
            margin: 2rem auto; max-width: 1300px; 
            display: flex; align-items: center; padding: 2rem; 
            position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        }
        .featured-badge { position: absolute; top: 0; left: 0; background: var(--primary); color: black; font-weight: 800; padding: 5px 15px; font-family: 'Teko'; font-size: 1.2rem; }
        .feat-img { width: 200px; height: 200px; object-fit: cover; border-radius: 4px; border: 1px solid #333; margin-right: 2rem; }
        .feat-info h2 { font-family: 'Teko'; font-size: 3rem; color: white; line-height: 1; margin-bottom: 10px; }
        .feat-info p { color: #ccc; font-size: 1.1rem; max-width: 600px; margin-bottom: 20px; }
        @media(max-width: 768px) { .featured-box { flex-direction: column; text-align: center; } .feat-img { margin: 0 0 20px 0; } }

        /* Reviews */
        .review-item { background: #1a1a1a; padding: 15px; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid var(--primary); }
        .star { color: gold; } .star.off { color: #333; }
        .prof-logo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); margin-right: 15px; }

        /* Profile Tabs */
        .prof-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #666; padding: 15px; font-family: 'Teko'; font-size: 1.2rem; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; animation: fadeUp 0.3s; }
        .tab-content.active { display: block; }
        .owner-img-lg { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="toast-box"></div>

    <nav id="main-nav">
        <div class="logo" onclick="app.go('home')">GPHS <span>DIRECTORY</span></div>
        <div id="nav-btns"></div>
    </nav>

    <div id="sticky-ad">
        <span class="ad-text">üî• BUY THE TOP SPOT FOR $2</span>
        <button class="btn btn-primary" onclick="app.msg('Contact Admin!'); document.getElementById('sticky-ad').classList.remove('visible')">GET FEATURED</button>
        <button style="background:none; border:none; color:#666; font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('sticky-ad').classList.remove('visible')">&times;</button>
    </div>

    <section id="home" class="view-section active">
        <div class="hero">
            <div class="mascot-box">
                <img src="mascot.png" alt="Mascot" class="mascot-img" onerror="this.style.display='none'">
            </div>
            <h1>GPHS STUDENT<br><span>BUSINESS DIRECTORY</span></h1>
            <p id="hero-slogan">These student businesses are truly in a class of their own.</p>
        </div>
        
        <div id="featured-container"></div>
        
        <div class="cta-banner">
            <div class="cta-text">
                <h2>Want More <span>Customers?</span></h2>
                <p>Don't let your talent go unnoticed. Get your business in front of the entire school in less than 60 seconds.</p>
            </div>
            <button class="cta-btn" onclick="app.openM('m-reg')">LIST MY BUSINESS &rarr;</button>
        </div>

        <div class="container">
            <div style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom: 2rem; gap: 1rem;">
                <div class="section-header" style="margin-bottom:0">Marketplace</div>
                <input type="text" id="searchInput" placeholder="Search businesses..." style="width:100%; max-width:300px; margin:0; border:1px solid #333;" onkeyup="app.search()">
            </div>
            <div id="grid" class="grid"></div>
        </div>
    </section>

    <section id="admin" class="view-section">
        <div class="container" style="padding-top:8rem">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="section-header" style="margin-bottom:0">ADMIN DASHBOARD</div>
                <button class="btn btn-outline" onclick="app.go('home')">EXIT</button>
                <button class="btn btn-danger" onclick="app.resetWeek()">RESET WEEKLY STATS</button>
            </div>
            <table class="admin-table"><thead><tr><th>Name</th><th>Owner</th><th>Status</th><th>Expires</th><th>Action</th></tr></thead><tbody id="admin-list"></tbody></table>
        </div>
    </section>

    <section id="owner" class="view-section">
        <div class="container" style="padding-top:8rem">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="section-header" style="margin-bottom:0">MY BUSINESS</div>
                <button class="btn btn-outline" onclick="app.go('home')">EXIT</button>
            </div>
            <div id="owner-panel"></div>
        </div>
    </section>

    <div id="m-login" class="modal"><div class="modal-box" style="max-width:400px"><div class="modal-header"><span class="modal-title">LOGIN</span><button onclick="app.closeM('m-login')" class="btn btn-outline" style="border:none">‚úï</button></div><div class="modal-body"><label>Username</label><input type="text" id="logUser" autocomplete="off"><label>Password</label><input type="password" id="logPass" autocomplete="off"><button class="btn btn-primary" style="width:100%" onclick="app.login()">Login</button><div style="text-align:center;margin:15px 0;color:#444">OR</div><button class="btn btn-outline" style="width:100%" onclick="app.openM('m-reg');app.closeM('m-login')">Create Business</button></div></div></div>
    
    <div id="m-reg" class="modal"><div class="modal-box"><div class="modal-header"><span class="modal-title">NEW SHOP</span><button onclick="app.closeM('m-reg')" class="btn btn-outline" style="border:none">‚úï</button></div><div class="modal-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>User</label><input type="text" id="regUser"></div><div><label>Pass</label><input type="password" id="regPass"></div></div><label>Business Name</label><input type="text" id="regName"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Location</label><input type="text" id="regLoc" placeholder="e.g. Cafeteria"></div><div><label>Hours</label><input type="text" id="regHours" placeholder="e.g. Lunch Only"></div></div><label>Desc</label><textarea id="regDesc"></textarea><label>Price</label><input type="text" id="regPrice"><label>Payment Methods</label><input type="text" id="regPay" placeholder="e.g. Cash, Venmo, CashApp"><div style="border-top:1px solid #333; padding-top:10px; margin:10px 0"><label style="color:var(--primary)">MEET THE OWNER</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Full Name</label><input type="text" id="regOwnerName"></div><div><label>Photo</label><input type="file" id="regOwnerImg" accept="image/*"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Position</label><input type="text" id="regOwnerPos" placeholder="e.g. Founder"></div><div><label>Social/Email</label><input type="text" id="regOwnerContact" placeholder="e.g. @insta"></div></div><label>Bio</label><textarea id="regOwnerBio" placeholder="Tell us about yourself..."></textarea></div><label>Logo (Optional)</label><input type="file" id="regLogo" accept="image/*"><label>Images (Select Multiple)</label><input type="file" id="regImg" accept="image/*" multiple><div style="background:#222; padding:10px; border-radius:4px; margin:10px 0; border:1px solid #444"><label style="color:white">ACCESS CODE (For Cash/Prepaid)</label><input type="text" id="regCode" placeholder="Enter code to skip payment" style="margin-bottom:0"></div><button class="btn btn-primary" style="width:100%" onclick="app.reg()">REGISTER & PAY</button></div></div></div>

    <div id="m-edit" class="modal"><div class="modal-box"><div class="modal-header"><span class="modal-title">MANAGE</span><button onclick="app.closeM('m-edit')" class="btn btn-outline" style="border:none">‚úï</button></div><div class="modal-body"><input type="hidden" id="eid"><label>Name</label><input type="text" id="ename"><label>Category</label><input list="cat-list" id="ecat" placeholder="Select or Type..."><datalist id="cat-list"><option value="General"><option value="Food & Drink"><option value="Services"><option value="Clothing"><option value="Technology"><option value="Art & Design"><option value="Entertainment"></datalist><label>Desc</label><textarea id="edesc"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Price</label><input type="text" id="eprice"></div><div><label>Contact</label><input type="text" id="esoc"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px; margin-top:10px"><div><label>Location</label><input type="text" id="eLoc"></div><div><label>Hours</label><input type="text" id="eHours"></div></div><label>Payment Methods</label><input type="text" id="ePay" placeholder="e.g. Cash, Venmo"><div style="border-top:1px solid #333; padding-top:10px; margin:10px 0"><label style="color:var(--primary)">OWNER PROFILE</label><label>Full Name</label><input type="text" id="eOwnerName"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Position</label><input type="text" id="eOwnerPos"></div><div><label>Social/Email</label><input type="text" id="eOwnerContact"></div></div><label>Bio</label><textarea id="eOwnerBio"></textarea></div><div id="admin-tools" style="display:none; border-top:1px solid #333; padding-top:15px; margin-top:10px;"><label style="color:var(--primary)">SUBSCRIPTION</label><div style="display:flex; gap:10px;"><input type="number" id="timeDays" value="7" style="width:60px; margin:0;"><button class="btn btn-primary" onclick="app.modTime(1)">Add</button><button class="btn btn-danger" onclick="app.modTime(-1)">Remove</button></div></div><div id="edit-btns" style="margin-top:20px; display:flex; gap:10px;"></div></div></div></div>

    <div id="m-prof" class="modal"><div class="modal-box" style="max-height:90vh; overflow-y:auto; overscroll-behavior: contain;"><div style="position:relative"><button onclick="app.closeM('m-prof')" style="position:absolute; top:15px; right:15px; background:rgba(0,0,0,0.5); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; z-index:20">‚úï</button><div id="prof-c"></div></div></div></div>

    <div id="m-review" class="modal"><div class="modal-box"><div class="modal-header"><span class="modal-title">WRITE REVIEW</span><button onclick="app.closeM('m-review')" class="btn btn-outline" style="border:none">‚úï</button></div><div class="modal-body"><input type="hidden" id="revId"><label>Your Name</label><input type="text" id="revName"><label>Rating (1-5)</label><select id="revRate"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option><option value="3">‚≠ê‚≠ê‚≠ê (3)</option><option value="2">‚≠ê‚≠ê (2)</option><option value="1">‚≠ê (1)</option></select><label>Comment</label><textarea id="revText"></textarea><button class="btn btn-primary" style="width:100%" onclick="app.submitReview()">Submit Review</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc, arrayUnion, increment, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- üî¥ PASTE YOUR KEYS HERE üî¥ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCH5pOZcM3XAP-1QpzPNHod6esnH8-1eyw",
            authDomain: "gphs-directory.firebaseapp.com",
            projectId: "gphs-directory",
            storageBucket: "gphs-directory.firebasestorage.app",
            messagingSenderId: "297370793888",
            appId: "1:297370793888:web:3c07bd158197cec94c96c5",
            measurementId: "G-SKMCJRYYKX"
        };

        const app = {
            db: null, user: null, isAdmin: false, cache: {}, currentImgs: [], currentImg: 0, publicList: [],

            init: async () => {
                try {
                    const fbApp = initializeApp(firebaseConfig);
                    const analytics = getAnalytics(fbApp);
                    app.db = getFirestore(fbApp);
                    console.log("DB Ready");
                    
                    // --- RANDOM PUN GENERATOR ---
                    const puns = [
                        "These student businesses are truly in a class of their own.",
                        "Why did the student start a business? To make a lot of cents!",
                        "Our entrepreneurs are too cool for school.",
                        "Support local students, it makes a lot of cents.",
                        "Don't be tardy to the party, shop student businesses!",
                        "Textbooks are heavy, but supporting students is easy.",
                        "Grade A products from Grade A students.",
                        "School spirit meets entrepreneurial spirit.",
                        "Putting the 'class' in classifieds.",
                        "We mean business, no cap and gown.",
                        "Shop smart, shop student-made.",
                        "Homework? Finished. Business? Booming.",
                        "From the classroom to the boardroom.",
                        "Investing in students pays the best interest.",
                        "Our products are principal approved.",
                        "Skip the cafeteria, feast on these deals.",
                        "Study hard, shop harder.",
                        "The only test you'll enjoy taking is testing our products.",
                        "Extra credit for supporting local businesses.",
                        "No hall pass needed to browse these shops.",
                        "Recess is over, it's time to shop.",
                        "Straight A's in quality and service.",
                        "Don't get suspended, spend it here!",
                        "School supplies? More like cool supplies.",
                        "History in the making with every sale.",
                        "Math class taught us to count on your support.",
                        "Science says these deals are attractive.",
                        "Reading between the lines? These shops are great.",
                        "Art class creativity on full display.",
                        "Gym class stamina running these businesses."
                    ];
                    const sloganEl = document.getElementById("hero-slogan");
                    if(sloganEl) sloganEl.innerText = puns[Math.floor(Math.random() * puns.length)];
                    
                    // --- RESTORE SESSION ---
                    const savedU = localStorage.getItem("gphs_user");
                    if(savedU) {
                        app.user = savedU;
                        app.isAdmin = (localStorage.getItem("gphs_role") === "true");
                        if(!app.isAdmin) app.loadOwner(app.user);
                    }

                    app.nav(); app.loadPublic();
                    setTimeout(() => document.getElementById('sticky-ad').classList.add('visible'), 2000);
                    
                    let lastScroll = 0;
                    window.addEventListener('scroll', () => {
                        const current = window.pageYOffset;
                        if (current > lastScroll && current > 100) document.getElementById('main-nav').classList.add('nav-hidden');
                        else document.getElementById('main-nav').classList.remove('nav-hidden');
                        lastScroll = current;
                    });
                } catch(e) { 
                    console.error(e); 
                    app.msg("Error: Keys Missing!", "bad");
                }
            },

            msg: (txt, type="good") => {
                const b = document.getElementById("toast-box");
                const d = document.createElement("div"); d.className = "toast"; 
                if(type==="bad") d.style.borderLeftColor="red";
                d.innerHTML = `<span>${txt}</span>`;
                b.appendChild(d); setTimeout(()=>d.remove(), 3000);
            },

            // New helper to compress images for database storage (No Bucket Needed)
            compress: (file, isLogo = false) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            
                            // Fix: Use MAX_DIM for both width and height to prevent huge vertical images
                            // and ensure integer dimensions to prevent "static lines" artifacts
                            const MAX_DIM = isLogo ? 300 : 600;
                            let w = img.width; let h = img.height;
                            
                            if (w > h) { if (w > MAX_DIM) { h *= MAX_DIM / w; w = MAX_DIM; } } 
                            else { if (h > MAX_DIM) { w *= MAX_DIM / h; h = MAX_DIM; } }
                            
                            canvas.width = Math.floor(w); canvas.height = Math.floor(h);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Force JPEG for non-logos to prevent 1MB limit errors
                            // Only allow PNG for logos (transparency)
                            const type = (isLogo && file.type === 'image/png') ? 'image/png' : 'image/jpeg';
                            const quality = isLogo ? 0.8 : 0.6;
                            resolve(canvas.toDataURL(type, quality));
                        };
                    };
                });
            },

            go: (id) => {
                document.querySelectorAll(".view-section").forEach(e=>e.classList.remove("active"));
                document.getElementById(id).classList.add("active");
                window.scrollTo(0,0);
                if(id==="admin") app.loadAdmin();
            },

            openM: (id) => document.getElementById(id).classList.add("active"),
            closeM: (id) => document.getElementById(id).classList.remove("active"),

            nav: () => {
                const c = document.getElementById("nav-btns");
                if(app.user) {
                    const page = app.isAdmin ? 'admin' : 'owner';
                    c.innerHTML = `<button class="btn btn-primary" onclick="app.go('${page}')">Dashboard</button> <button class="btn btn-danger" style="margin-left:10px" onclick="app.logout()">Log Out</button>`;
                } else {
                    c.innerHTML = `<button class="btn btn-outline" onclick="app.openM('m-login')">Login</button>`;
                }
            },

            // --- AUTH LOGIC (FIXED) ---
            login: async () => {
                const u = document.getElementById("logUser").value.trim();
                const p = document.getElementById("logPass").value.trim();
                if(!u) return app.msg("Username needed", "bad");

                if(u.toLowerCase()==="admin" && p==="hornet") { 
                    app.user="admin"; app.isAdmin=true; app.closeM("m-login"); app.nav(); app.go("admin");
                    localStorage.setItem("gphs_user", "admin"); localStorage.setItem("gphs_role", "true");
                    app.msg("Welcome Admin");
                    return;
                }

                try {
                    if(!app.db) return app.msg("Database not connected", "bad");

                    // EXACT CHECK
                    const q = query(collection(app.db, "applications"), where("owner", "==", u));
                    const snap = await getDocs(q);
                    
                    if(snap.empty) {
                        app.msg("User not found.", "bad");
                        return;
                    }

                    const data = snap.docs[0].data();
                    
                    if(data.password && data.password !== p) {
                        app.msg("Wrong password.", "bad");
                        return;
                    }

                    app.user = u; app.isAdmin = false; 
                    app.closeM("m-login"); app.nav(); 
                    localStorage.setItem("gphs_user", u); localStorage.setItem("gphs_role", "false");
                    app.loadOwner(u); app.go("owner");
                    app.msg("Welcome Back!");

                } catch(e) {
                    console.error(e); app.msg("Login Error", "bad");
                }
            },

            logout: () => { app.user=null; app.isAdmin=false; localStorage.removeItem("gphs_user"); localStorage.removeItem("gphs_role"); app.nav(); app.go("home"); },

            reg: async () => {
                const u=document.getElementById("regUser").value.trim(); 
                const p=document.getElementById("regPass").value.trim();
                const b=document.getElementById("regName").value;
                const code=document.getElementById("regCode").value.trim();
                const btn = document.querySelector("#m-reg .btn-primary");
                
                if(!u||!p||!b) return app.msg("Fill all fields", "bad");
                if(btn) { btn.disabled = true; btn.innerText = "Processing..."; }

                try {
                    const q = query(collection(app.db, "applications"), where("owner", "==", u));
                    const snap = await getDocs(q);
                    if(!snap.empty) return app.msg("Username taken", "bad");

                    let imgs = [];
                    let logoUrl = "";
                    let ownerUrl = "";
                    const files = document.getElementById("regImg").files;
                    const logoFile = document.getElementById("regLogo").files[0];
                    const ownerFile = document.getElementById("regOwnerImg").files[0];
                    
                    if(files.length > 0 || logoFile || ownerFile) app.msg("Processing images...", "good");
                    
                    if(files.length > 0) {
                        for(let i=0; i<files.length; i++) imgs.push(await app.compress(files[i], false));
                    }
                    if(logoFile) logoUrl = await app.compress(logoFile, false);
                    if(ownerFile) ownerUrl = await app.compress(ownerFile, false);

                    // --- PAYMENT / CODE LOGIC ---
                    let subEnd = 0; // Default: Expired/Unpaid
                    let status = "pending_payment";
                    
                    // CHECK CODE (You can change "CASH" to whatever secret code you want)
                    if(code === "CASH" || code === "GPHS2024") {
                        subEnd = Date.now() + (365 * 86400000); // 1 Year Access
                        status = "approved";
                    }

                    await addDoc(collection(app.db, "applications"), { 
                        owner:u, password:p, business:b, 
                        description:document.getElementById("regDesc").value, 
                        price:document.getElementById("regPrice").value,
                        location:document.getElementById("regLoc").value,
                        hours:document.getElementById("regHours").value,
                        payment:document.getElementById("regPay").value,
                        ownerName:document.getElementById("regOwnerName").value, ownerPos:document.getElementById("regOwnerPos").value, ownerContact:document.getElementById("regOwnerContact").value, ownerBio:document.getElementById("regOwnerBio").value, ownerImg: ownerUrl,
                        images: imgs, imageURL: imgs[0] || "", logo: logoUrl, 
                        status: status, 
                        subscriptionEnd: subEnd, 
                        timestamp: new Date() 
                    });

                    if(status === "approved") {
                        app.msg("Code Accepted! Registered."); app.closeM("m-reg");
                    } else {
                        app.msg("Redirecting to Payment...", "good");
                        // üî¥ PASTE YOUR STRIPE PAYMENT LINK BELOW (Get it from Stripe Dashboard > Payment Links)
                        setTimeout(() => window.location.href = "https://buy.stripe.com/fZu6oI2mD6w0dLF1ZR6Vq0l", 1500);
                    }
                } catch(e) {
                    console.error(e); app.msg("Error: " + e.message, "bad");
                    if(btn) { btn.disabled = false; btn.innerText = "Register & Pay"; }
                }
            },

            // --- DATA ---
            loadPublic: async () => {
                if(!app.db) return;
                const g = document.getElementById("grid"); g.innerHTML = "Loading...";
                const q = query(collection(app.db, "applications"), where("status","==","approved"));
                const s = await getDocs(q);
                const now = Date.now();
                
                app.publicList = [];
                s.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id;
                    if(d.subscriptionEnd && d.subscriptionEnd < now) return;
                    app.cache[doc.id] = d;
                    app.publicList.push(d);
                });
                
                app.renderGrid(app.publicList);
                app.loadFeatured();
            },

            renderGrid: (list) => {
                const g = document.getElementById("grid"); g.innerHTML = "";
                if(list.length === 0) { g.innerHTML = "<p style='color:#666'>No businesses found.</p>"; return; }

                list.forEach(d => {
                    const img = (d.images && d.images.length > 0) ? d.images[0] : (d.imageURL || "");
                    let imgHtml = img.length > 5 ? 
                        `<div class="card-img-box"><img src="${img}" class="card-img" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\\'card-placeholder\\'><i class=\\'fa-solid fa-store\\'></i></div>'"></div>` : 
                        `<div class="card-img-box"><div class="card-placeholder"><i class="fa-solid fa-store"></i></div></div>`;

                    const div = document.createElement("div");
                    div.className = "card";
                    div.onclick = () => app.prof(d.id);
                    div.innerHTML = `${imgHtml}<div class="card-body"><div class="card-cat">${d.category||'Biz'}</div><h3>${d.business}</h3><p>${d.description ? d.description.substring(0,80) : 'No description.'}...</p><div class="card-foot"><span class="price">${d.price}</span><span class="view-btn">View</span></div></div>`;
                    g.appendChild(div);
                });
            },

            search: () => {
                const term = document.getElementById("searchInput").value.toLowerCase();
                const filtered = app.publicList.filter(d => 
                    d.business.toLowerCase().includes(term) || 
                    (d.category && d.category.toLowerCase().includes(term))
                );
                app.renderGrid(filtered);
            },

            prof: (id) => {
                const d = app.cache[id];
                const c = document.getElementById("prof-c");
                
                // Analytics: Increment view count (if not owner)
                if(app.user !== d.owner) {
                    updateDoc(doc(app.db, "applications", id), { views: increment(1), weeklyViews: increment(1), lastView: Date.now() }).catch(console.error);
                }
                
                const imgs = d.images || (d.imageURL ? [d.imageURL] : []);
                app.currentImgs = imgs; app.currentImg = 0;

                let imgDisplay = "";
                if(imgs.length === 0) {
                    imgDisplay = `<div style="height:200px; background:#222; display:flex; align-items:center; justify-content:center; color:#444; font-size:2rem; font-weight:800;">${d.business.charAt(0)}</div>`;
                } else {
                    const arrows = imgs.length > 1 ? `<button class="slider-btn prev-btn" onclick="app.slide(-1)">&#10094;</button><button class="slider-btn next-btn" onclick="app.slide(1)">&#10095;</button>` : ``;
                    imgDisplay = `<div style="position:relative; height:300px; background:#000;">${arrows}<img id="prof-img-display" src="${imgs[0]}" style="width:100%; height:100%; object-fit:contain;"></div>`;
                }

                let logoHtml = d.logo ? `<img src="${d.logo}" class="prof-logo">` : ``;
                let reviewsHtml = `<div style="margin-top:20px; border-top:1px solid #333; padding-top:20px"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px"><h3 style="font-family:'Teko'; font-size:1.5rem">REVIEWS</h3><button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem" onclick="app.openReview('${id}')">Write Review</button></div>`;
                
                if(d.reviews && d.reviews.length > 0) {
                    d.reviews.forEach((r, i) => {
                        let stars = ""; for(let j=0;j<5;j++) stars += `<i class="fa-solid fa-star star ${j<r.rating?'':'off'}"></i>`;
                        let delBtn = app.isAdmin ? `<button onclick="app.delReview('${id}', ${i})" style="background:red; color:white; border:none; padding:2px 6px; font-size:0.7rem; cursor:pointer; margin-left:10px; border-radius:2px">DEL</button>` : ``;
                        reviewsHtml += `<div class="review-item"><div style="display:flex; justify-content:space-between"><span style="font-weight:700; color:white">${r.name} ${delBtn}</span><span>${stars}</span></div><p style="color:#aaa; font-size:0.9rem; margin-top:5px">${r.text}</p></div>`;
                    });
                } else {
                    reviewsHtml += `<p style="color:#666">No reviews yet.</p>`;
                }
                reviewsHtml += `</div>`;

                let ownerImgDisplay = d.ownerImg ? `<img src="${d.ownerImg}" class="owner-img-lg">` : `<div class="owner-img-lg" style="background:#222; display:flex; align-items:center; justify-content:center; margin:0 auto 15px auto"><i class="fa-solid fa-user" style="font-size:3rem; color:#444"></i></div>`;

                c.innerHTML = `<div class="prof-tabs"><button id="btn-biz" class="tab-btn active" onclick="app.tab('biz')">BUSINESS</button><button id="btn-owner" class="tab-btn" onclick="app.tab('owner')">MEET THE OWNER</button></div>
                <div id="tab-biz" class="tab-content active">${imgDisplay}<div style="padding:2rem;"><div style="display:flex; align-items:center; margin-bottom:15px">${logoHtml}<div><h1 style="font-family:'Teko'; font-size:2.5rem; line-height:0.9; color:white; margin:0">${d.business}</h1><p style="color:#666; font-size:0.9rem; margin-top:2px">Run by ${d.ownerName || d.owner}</p></div></div><p style="color:#ccc; line-height:1.6; font-size:1rem; margin-bottom:20px; text-align:center">${d.description||"No details."}</p><div style="background:#1a1a1a; padding:15px; border-radius:4px; display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px"><div><label>PRICE</label><div style="color:white; font-weight:700;">${d.price}</div></div><div><label>CONTACT</label><div style="color:white; font-weight:700;">${d.social||"N/A"}</div></div><div><label>LOCATION</label><div style="color:white; font-weight:700;">${d.location||"N/A"}</div></div><div><label>HOURS</label><div style="color:white; font-weight:700;">${d.hours||"N/A"}</div></div><div><label>PAYMENT</label><div style="color:white; font-weight:700;">${d.payment||"Cash"}</div></div></div>${reviewsHtml}<button class="btn btn-outline" style="width:100%; margin-top:20px" onclick="app.closeM('m-prof')">CLOSE PROFILE</button></div></div>
                <div id="tab-owner" class="tab-content"><div style="padding:2rem; text-align:center">${ownerImgDisplay}<h1 style="font-family:'Teko'; font-size:3rem; color:white; line-height:1">${d.ownerName || d.owner}</h1><p style="color:var(--primary); font-weight:700; margin-bottom:5px; text-transform:uppercase">${d.ownerPos || "Owner"}</p><p style="color:#888; font-size:0.9rem; margin-bottom:20px">${d.ownerContact || ""}</p><div style="background:#1a1a1a; padding:20px; border-radius:8px; text-align:left; line-height:1.6; color:#ccc">${d.ownerBio || "No bio available."}</div><button class="btn btn-outline" style="width:100%; margin-top:20px" onclick="app.closeM('m-prof')">CLOSE PROFILE</button></div></div>`;
                app.openM("m-prof");
            },
            
            slide: (dir) => {
                app.currentImg += dir;
                if(app.currentImg < 0) app.currentImg = app.currentImgs.length - 1;
                if(app.currentImg >= app.currentImgs.length) app.currentImg = 0;
                const img = document.getElementById("prof-img-display");
                if(img) img.src = app.currentImgs[app.currentImg];
            },

            tab: (t) => {
                document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
                document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
                document.getElementById("btn-" + t).classList.add("active");
                document.getElementById("tab-" + t).classList.add("active");
            },

            delImg: async (id, idx) => {
                const d = app.cache[id];
                const newImgs = d.images.filter((_, i) => i !== idx);
                const newUrl = newImgs.length > 0 ? newImgs[0] : "";
                await updateDoc(doc(app.db, "applications", id), { images: newImgs, imageURL: newUrl });
                app.cache[id].images = newImgs; app.cache[id].imageURL = newUrl;
                if(app.isAdmin) app.edit(id, true); else app.loadOwner(app.user); app.msg("Image deleted");
            },

            delLogo: async (id) => {
                await updateDoc(doc(app.db, "applications", id), { logo: "" });
                app.cache[id].logo = "";
                if(app.isAdmin) app.edit(id, true); else app.loadOwner(app.user); app.msg("Logo deleted");
            },

            openReview: (id) => { document.getElementById("revId").value = id; document.getElementById("revName").value=""; document.getElementById("revText").value=""; app.openM("m-review"); },
            
            submitReview: async () => {
                const id = document.getElementById("revId").value;
                const n = document.getElementById("revName").value;
                const r = document.getElementById("revRate").value;
                const t = document.getElementById("revText").value;
                if(!n || !t) return app.msg("Fill all fields", "bad");
                await updateDoc(doc(app.db, "applications", id), { reviews: arrayUnion({ name:n, rating:parseInt(r), text:t, date:Date.now() }) });
                app.msg("Review Added!"); app.closeM("m-review"); app.loadPublic(); app.closeM("m-prof");
            },

            delReview: async (id, idx) => {
                const d = app.cache[id];
                const newReviews = d.reviews.filter((_, i) => i !== idx);
                await updateDoc(doc(app.db, "applications", id), { reviews: newReviews });
                app.cache[id].reviews = newReviews;
                app.prof(id); app.msg("Review deleted");
            },

            loadFeatured: async () => {
                if(!app.db) return;
                const c = document.getElementById("featured-container");
                const q = query(collection(app.db, "applications"), where("status", "==", "approved"), orderBy("weeklyViews", "desc"), limit(1));
                try {
                    const s = await getDocs(q);
                    if(s.empty) { c.innerHTML = ""; return; }
                    const d = s.docs[0].data();
                    if(!d.weeklyViews || d.weeklyViews < 1) { c.innerHTML = ""; return; }
                    const img = (d.images && d.images.length > 0) ? d.images[0] : (d.imageURL || "mascot.png");
                    c.innerHTML = `<div class="featured-box"><div class="featured-badge">üèÜ BUSINESS OF THE WEEK</div><img src="${img}" class="feat-img"><div class="feat-info"><h2>${d.business}</h2><p>${d.description ? d.description.substring(0, 150) : ""}...</p><button class="btn btn-primary" onclick="app.prof('${s.docs[0].id}')">VISIT PROFILE</button></div></div>`;
                } catch(e) { console.error(e); }
            },

            loadAdmin: async () => {
                if(!app.db) return;
                const t = document.getElementById("admin-list"); t.innerHTML = "<tr><td colspan='5'>Loading fresh data...</td></tr>";
                try {
                    const s = await getDocs(collection(app.db, "applications"));
                    t.innerHTML = "";
                    const now = Date.now();
                    if(s.empty) { t.innerHTML = "<tr><td colspan='5'>No applications found.</td></tr>"; return; }
                    s.forEach(doc => {
                        const d = doc.data(); app.cache[doc.id] = d;
                        let st = "b-live"; let txt = "Live";
                        if(d.status === "pending") { st = "b-wait"; txt = "Pending"; }
                        if(d.subscriptionEnd && d.subscriptionEnd < now) { st = "b-dead"; txt = "Expired"; }
                        let days = d.subscriptionEnd > now ? Math.ceil((d.subscriptionEnd-now)/86400000)+"d" : "0d";
                        t.innerHTML += `<tr><td>${d.business}</td><td>${d.owner}</td><td><span class="badge ${st}">${txt}</span></td><td>${days}</td><td><button class="btn btn-outline" style="padding:5px" onclick="app.edit('${doc.id}', true)">Edit</button></td></tr>`;
                    });
                } catch(e) { console.error(e); t.innerHTML = "<tr><td colspan='5'>Error loading.</td></tr>"; }
            },

            loadOwner: async (u) => {
                if(!app.db) return;
                const p = document.getElementById("owner-panel"); p.innerHTML = "Loading...";
                const q = query(collection(app.db, "applications"), where("owner","==",u));
                const s = await getDocs(q);
                if(s.empty) { p.innerHTML = `<p>No business found.</p><button class="btn btn-primary" onclick="app.openM('m-reg')">Create One Now</button>`; return; }
                const doc = s.docs[0]; const d = doc.data(); app.cache[doc.id] = d;
                const now = Date.now();
                
                // --- PENDING PAYMENT SCREEN ---
                if(d.status === "pending_payment") {
                    p.innerHTML = `
                        <div style="text-align:center; padding: 40px; background:#151515; border-radius:8px; border:1px solid #333; border-top: 4px solid var(--primary);">
                            <h1 style="font-family:'Teko'; font-size:3rem; color:white; margin-bottom:10px">PAYMENT REQUIRED</h1>
                            <p style="color:#ccc; margin-bottom:30px; font-size:1.1rem">Your application is pending. Please complete the payment to activate your listing.</p>
                            <button class="btn btn-primary" style="font-size:1.2rem; padding: 15px 40px;" onclick="window.location.href='https://buy.stripe.com/YOUR_ACTUAL_LINK_HERE'">PAY NOW &rarr;</button>
                            <p style="margin-top:30px; font-size:0.9rem; color:#666">Already paid? Please wait for an admin to approve your listing.<br>Contact us if it takes longer than 24h.</p>
                        </div>`;
                    return;
                }

                const days = d.subscriptionEnd > now ? Math.ceil((d.subscriptionEnd-now)/86400000) : 0;
                const views = d.views || 0;
                const weekly = d.weeklyViews || 0;
                const lastView = d.lastView ? new Date(d.lastView).toLocaleDateString() : "N/A";
                
                let logoHtml = d.logo ? `<div style="text-align:center; margin-bottom:20px"><img src="${d.logo}" style="width:120px; height:120px; border-radius:50%; border:2px solid var(--primary); object-fit:cover; margin-bottom:10px"><br><button class="btn btn-danger" onclick="app.delLogo('${doc.id}')">Delete Logo</button></div>` : `<div style="background:#151515; padding:20px; border-radius:4px; text-align:center; margin-bottom:20px"><label>UPLOAD LOGO</label><input type="file" id="dashLogo" accept="image/*"><button class="btn btn-primary" onclick="app.saveLogo('${doc.id}')">Save Logo</button></div>`;
                let ownerImgHtml = d.ownerImg ? `<div style="text-align:center; margin-bottom:20px"><img src="${d.ownerImg}" style="width:120px; height:120px; border-radius:50%; border:2px solid var(--primary); object-fit:cover; margin-bottom:10px"><br><button class="btn btn-danger" onclick="app.saveOwnerImg('${doc.id}', true)">Delete Photo</button></div>` : `<div style="background:#151515; padding:20px; border-radius:4px; text-align:center; margin-bottom:20px"><label>OWNER PHOTO</label><input type="file" id="dashOwnerImg" accept="image/*"><button class="btn btn-primary" onclick="app.saveOwnerImg('${doc.id}')">Save Photo</button></div>`;

                let imgsHtml = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:10px; margin-bottom:15px">`;
                if(d.images && d.images.length > 0) {
                    d.images.forEach((url, i) => {
                        imgsHtml += `<div style="position:relative"><img src="${url}" style="width:100%; height:100px; object-fit:cover; border-radius:4px; border:1px solid #333"><button onclick="app.delImg('${doc.id}', ${i})" style="position:absolute; top:0; right:0; background:red; color:white; border:none; width:24px; height:24px; cursor:pointer;">‚úï</button></div>`;
                    });
                }
                imgsHtml += `</div><div style="background:#151515; padding:20px; border-radius:4px"><label>ADD PHOTOS</label><input type="file" id="dashImgs" accept="image/*" multiple><button class="btn btn-primary" onclick="app.saveImages('${doc.id}')">Upload Photos</button></div>`;

                p.innerHTML = `<div style="display:grid; grid-template-columns: 1fr; gap:20px"><div style="background:#111; padding:20px; border:1px solid #333; border-top:4px solid var(--primary)"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px"><h2 style="font-family:'Teko'; margin:0; font-size:2rem">${d.business}</h2><span class="badge ${d.status==='approved'?'b-live':'b-wait'}">${d.status}</span></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">${logoHtml}${ownerImgHtml}</div><div style="margin-top:20px; border-top:1px solid #222; padding-top:20px"><label style="color:var(--primary)">GALLERY</label>${imgsHtml}</div></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px"><div style="background:#111; padding:20px; border:1px solid #333;"><h3 style="font-family:'Teko'">SUBSCRIPTION</h3><h1 style="font-size:4rem; line-height:1; color:white">${days} <span style="font-size:1rem; color:#666">DAYS LEFT</span></h1><button class="btn btn-outline" style="width:100%; margin-top:10px" onclick="app.edit('${doc.id}', false)">Edit Business</button></div><div style="background:#111; padding:20px; border:1px solid #333;"><h3 style="font-family:'Teko'">TRAFFIC</h3><div style="display:flex; justify-content:space-between; margin-bottom:10px"><div><h1 style="font-size:3rem; line-height:1; color:white">${weekly}</h1><span style="font-size:0.8rem; color:#666">THIS WEEK</span></div><div style="text-align:right"><h1 style="font-size:3rem; line-height:1; color:white">${views}</h1><span style="font-size:0.8rem; color:#666">ALL TIME</span></div></div><p style="color:#666; font-size:0.8rem; margin-top:5px">Last visit: ${lastView}</p></div></div></div>`;
            },

            edit: (id, isAdm) => {
                const d = app.cache[id];
                document.getElementById("eid").value=id; document.getElementById("ename").value=d.business; document.getElementById("edesc").value=d.description||""; document.getElementById("eprice").value=d.price; document.getElementById("esoc").value=d.social||""; document.getElementById("eLoc").value=d.location||""; document.getElementById("eHours").value=d.hours||""; document.getElementById("ePay").value=d.payment||""; document.getElementById("eOwnerName").value=d.ownerName||""; document.getElementById("eOwnerPos").value=d.ownerPos||""; document.getElementById("eOwnerContact").value=d.ownerContact||""; document.getElementById("eOwnerBio").value=d.ownerBio||"";

                const tools = document.getElementById("admin-tools"); const btns = document.getElementById("edit-btns");
                if(isAdm) { tools.style.display="block"; btns.innerHTML=`<button class="btn btn-primary" style="flex:1" onclick="app.save(true)">Approve</button> <button class="btn btn-danger" onclick="app.del()">Delete</button>`; } 
                else { tools.style.display="none"; btns.innerHTML=`<button class="btn btn-primary" style="flex:1" onclick="app.save(false)">Save</button>`; }
                app.openM("m-edit");
            },

            save: async (appr) => {
                const btn = document.querySelector("#edit-btns button");
                if(btn) { btn.disabled = true; btn.innerText = "Processing..."; }

                try {
                    const id = document.getElementById("eid").value;
                    const u = { business: document.getElementById("ename").value, description: document.getElementById("edesc").value, price: document.getElementById("eprice").value, social: document.getElementById("esoc").value, category: document.getElementById("ecat").value, location: document.getElementById("eLoc").value, hours: document.getElementById("eHours").value, payment: document.getElementById("ePay").value, ownerName: document.getElementById("eOwnerName").value, ownerPos: document.getElementById("eOwnerPos").value, ownerContact: document.getElementById("eOwnerContact").value, ownerBio: document.getElementById("eOwnerBio").value };
                    if(appr) u.status="approved";
                    
                    await updateDoc(doc(app.db, "applications", id), u);
                    app.msg("Saved"); app.closeM("m-edit");
                    if(app.isAdmin) await app.loadAdmin(); else await app.loadOwner(app.user); app.loadPublic();
                } catch(e) {
                    console.error(e); app.msg("Error: " + e.message, "bad");
                    if(btn) { btn.disabled = false; btn.innerText = "Retry"; }
                }
            },

            saveLogo: async (id) => {
                const file = document.getElementById("dashLogo").files[0];
                if(!file) return app.msg("Select a file", "bad");
                app.msg("Uploading...", "good");
                const url = await app.compress(file, false);
                await updateDoc(doc(app.db, "applications", id), { logo: url });
                app.msg("Logo Saved"); app.loadOwner(app.user);
            },

            saveOwnerImg: async (id, del=false) => {
                if(del) {
                    if(!confirm("Delete owner photo?")) return;
                    await updateDoc(doc(app.db, "applications", id), { ownerImg: "" });
                    app.msg("Photo Deleted"); app.loadOwner(app.user); return;
                }
                const file = document.getElementById("dashOwnerImg").files[0];
                if(!file) return app.msg("Select a file", "bad");
                app.msg("Uploading...", "good");
                const url = await app.compress(file, false);
                await updateDoc(doc(app.db, "applications", id), { ownerImg: url });
                app.msg("Photo Saved"); app.loadOwner(app.user);
            },

            saveImages: async (id) => {
                const files = document.getElementById("dashImgs").files;
                if(files.length === 0) return app.msg("Select files", "bad");
                app.msg("Uploading...", "good");
                let newImgs = [];
                for(let i=0; i<files.length; i++) newImgs.push(await app.compress(files[i], false));
                await updateDoc(doc(app.db, "applications", id), { images: arrayUnion(...newImgs) });
                app.msg("Images Added"); app.loadOwner(app.user);
            },

            modTime: async (m) => {
                const id = document.getElementById("eid").value; const days = parseInt(document.getElementById("timeDays").value); const ms = days*86400000*m;
                const s = await getDocs(collection(app.db, "applications")); let curr=0; s.forEach(x=>{if(x.id===id)curr=x.data().subscriptionEnd||0});
                const now = Date.now();
                await updateDoc(doc(app.db, "applications", id), {subscriptionEnd: (curr<now?now:curr)+ms});
                app.msg("Time Updated"); app.closeM("m-edit"); app.loadAdmin();
            },

            del: async () => { if(!confirm("Delete?")) return; await deleteDoc(doc(app.db, "applications", document.getElementById("eid").value)); app.msg("Deleted"); app.closeM("m-edit"); app.loadAdmin(); app.loadPublic(); },

            resetWeek: async () => {
                if(!confirm("Reset all weekly view counts to 0? This starts a new week.")) return;
                app.msg("Resetting...", "good");
                const s = await getDocs(collection(app.db, "applications"));
                const batch = writeBatch(app.db);
                s.forEach(doc => { batch.update(doc.ref, { weeklyViews: 0 }); });
                await batch.commit();
                app.msg("Weekly stats reset."); app.loadAdmin();
            }
        };

        window.app = app; app.init();
    </script>
</body>
</html>
